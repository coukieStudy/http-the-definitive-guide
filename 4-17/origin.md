## 내용 협상과 트랜스코딩

하나의 URL이 여러 리소스에 대응할 필요가 있는 경우가 존재한다. 제일 대표적인 예시는 다국이. 영어 사용자와 프랑스어 사용자가 있고,
영어와 프랑스어에 해당하는 버젼이 있을 때, 영어 사용자에게는 영어 버젼의 문서를 제공하고 프랑스어 사용자에게는 프랑스어 버젼의 문서를
제공하려고 한다.

서버가 제공하는 여러 버젼(variant) 중 어떤 버젼을 선택하는 지를 조율하는 과정을 내용협상 이라고 하고, 그 주도권을 누가 가져가는
지에 따라 세 가지 방식으로 나눌 수 있다.

### 클라이언트 주도
> 가능한 페이지의 목록을 응답으로 보내주어 클라이언트가 보고 싶은 것을 선택하게 한다.
여러 버젼에 대한 링크가 담긴 별도의 HTML페이지를 돌려주거나, 사용자가 결정을 할 수 있도록 대화창을 띄울 수 있다.

장점)
* 서버 입장에서 구현하기 가장 쉽다
* 클라이언트가 최선의 결과를 얻을 수 있다.

단점)
* 한 페이지에 대한 요청이 여러 번 필요하다 (자원에 대한 요청 + 버젼에 대한 요청)
* 여러 버젼에 대한 링크를 담을 페이지에 대한 별도의 구현이 필요하다. 예를들어 A.com의 영어버젼 A.com/en 그리고 프랑스어버젼
A.com/fr 이 있을 때, 이를 선택하게 하는 페이지가 필요하다. 

### 서버 주도
> 서버가 어떤 버젼을 내려줄 지 결정한다. ㅇㄹ
이게 가능하기 위해서는 클라이언트는 자신이 무엇을 선호하는 지에 대한 충분한 정보를 서버에게 주어서 서버가 결정할 수 있도록 해야 한다.
HTTP서버는 Accept 관련 헤더를 비롯한 헤더들에서 정보를 얻는다.

Accept 관련 헤더들
![image](https://user-images.githubusercontent.com/37106166/117853095-f9d7c880-b2c2-11eb-9331-f7b681025ca8.png)

그러나 이 헤더로 충분한 것은 아니다. 불어와 영어 버젼이 있을 때 스페인어 사용자에게는 그 사용자가 제2 언어로 선호하는 언어에 대한 
버젼을 제공해야 한다. 이 정보를 나타내는 값이 품질값(quality value, q값)이다. 네덜란드어를 가장 선호하지만 영어도 이해할 수 
있는 클라이언트의 헤더는 다음과 같다.

Accept-Langugae: en;q=0.5 fr;q=0.0 nl;q=1.0

Accept 관련 헤더 뿐 아니라 User-Agent와 같은 헤더들 역시 버젼 선택에 도움을 줄 수 있다. 예를 들어 클라이언트가 오래된 버젼의
웹브라우저를 사용하고 있다면, 최신 자바스크립트를 포함하지 않는 페이지를 돌려줄 수 있다.

이처럼 서버는 클라이언트의 여러 헤더값을 참조해서 버젼을 결정하게 되는데, 일반적으로 참조하는 Accept 헤더와 User-Agent 헤더를
제외하고 자신이 참조한 헤더는 Vary 헤더에 넣어서 응답하게 된다. 


### 투명 협상
> 중개 프락시를 두어서 메시지 교환을 최소화하고, 서버 주도 협상으로 인한 부하를 서버에서 제거한다.

이 방식은 클라이언트 주도와 서버 주도의 단점들을 적절하게 해결하고 있다. 하지만 잘못된 응답을 제공할 가능성이 존재한다.
만약 프락시가 URL만 캐싱한다면, 순차적으로 다른 언어를 원하는 클라이언트들의 요청에는 제대로 된 응답을 제공하지 못하게 된다.
아래의 경우에서는 Accept-language 에 따라서 응답이 달라진다.

![image](https://user-images.githubusercontent.com/37106166/117854675-aebeb500-b2c4-11eb-862f-8e8a1aca4bdb.png)

하지만 서버가 (일반적으로 사용되는) Accept 헤더 외의 다른 헤더들을 이용해 버젼 구분을 하고 있을 수도 있다. 이 때 프락시는 
어떤 헤더를 기준으로 캐싱을 해야하는 지를 알 수가 없다. 이 때 서버의 응답에 Vary 헤더 안의 헤더들이 일종의 cache key 역할을 
할 수 있다.

![image](https://user-images.githubusercontent.com/37106166/117855849-dfebb500-b2c5-11eb-8eae-0f70fd5ffe1d.png)

### 트랜스코딩

> 서버가 클라이언트의 요구에 맞는 문서를 아예 갖고 있지 않은 경우, 서버가 기존의 문서를 클라이언트가 사용할 수 있는 무언가로 변환하는 과정

1. 포맷 변환: 한 포맷에서 다른 포맷으로의 변환 (HTML -> WML, 64K이미지 -> 흑백 이미지)
2. 정보 합성: 문서에서 정보의 요점을 추출해서 제공한다. (각 절의 제목에 기반한 개요 문서의 생성, 광고 및 로고 제거)
3. 콘텐츠 주입: 필요한 내용을 자동으로 삽입해서 제공 (자동 광고 생성)

서버가 미리 모든 사본을 만들어두면 좋겠지만, 클라이언트의 모든 요구에 대응하는 것은 불가능하고 저장 공간의 한계도 존재한다. 또한 타겟 광고 삽입과 같은 트랜스코딩은 정적인 방법으로는
수행할 수 없다. 







